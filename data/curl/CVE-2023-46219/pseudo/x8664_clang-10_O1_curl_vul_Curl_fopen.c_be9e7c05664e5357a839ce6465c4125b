CURLcode __fastcall Curl_fopen(Curl_easy *data, const char *filename, FILE **fh, char **tempname)
{
  __mode_t st_mode; // r13d
  CURLcode v7; // eax
  CURLcode v8; // r12d
  char *v9; // rbx
  int v10; // ebp
  FILE *v11; // rcx
  CURLcode result; // eax
  const char *v13; // rax
  int v14; // eax
  FILE *v15; // rcx
  char v16[9]; // [rsp+Fh] [rbp-159h] BYREF
  struct stat buf; // [rsp+18h] [rbp-150h] BYREF
  struct stat v18; // [rsp+A8h] [rbp-C0h] BYREF

  *tempname = 0LL;
  if ( stat_0(filename, &buf) == -1 || (st_mode = buf.st_mode, (buf.st_mode & 0xF000) != 0x8000) )
  {
    v11 = fopen(filename, "w");
    *fh = v11;
    result = CURLE_OK;
    if ( v11 )
      return result;
    v10 = -1;
    v8 = CURLE_WRITE_ERROR;
    v9 = 0LL;
    goto fail;
  }
  v7 = (unsigned int)Curl_rand_hex(data, v16, 9LL);
  if ( v7 )
  {
    v8 = v7;
LABEL_5:
    v9 = 0LL;
    v10 = -1;
    goto fail;
  }
  v13 = (const char *)curl_maprintf("%s.%s.tmp", filename, v16);
  if ( !v13 )
  {
    v8 = CURLE_OUT_OF_MEMORY;
    goto LABEL_5;
  }
  v9 = (char *)v13;
  v14 = open(v13, 193, 384LL);
  v8 = CURLE_WRITE_ERROR;
  if ( v14 == -1 )
  {
    v10 = -1;
  }
  else
  {
    v10 = v14;
    if ( fstat(v14, &v18) == -1 || v18.st_uid != buf.st_uid || v18.st_gid != buf.st_gid || fchmod(v10, st_mode) != -1 )
    {
      v15 = fdopen(v10, "w");
      *fh = v15;
      result = CURLE_OK;
      if ( v15 )
        goto LABEL_11;
    }
  }
fail:
  if ( v10 != -1 )
  {
    close(v10);
    unlink(v9);
  }
  Curl_cfree(v9);
  v9 = 0LL;
  result = v8;
LABEL_11:
  *tempname = v9;
  return result;
}
