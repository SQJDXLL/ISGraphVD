// bad sp value at call has been detected, the output may be wrong!
CURLcode __cdecl Curl_fopen(Curl_easy *data, const char *filename, FILE **fh, char **tempname)
{
  int v4; // edx
  const char *v5; // esi
  int v6; // eax
  int v7; // eax
  int v8; // eax
  int v9; // edi
  __gid_t v10; // ecx
  FILE *v11; // eax
  int v13; // [esp-Ch] [ebp-100h]
  int v14; // [esp-8h] [ebp-FCh]
  int v15; // [esp-4h] [ebp-F8h]
  int v16; // [esp+0h] [ebp-F4h]
  _DWORD *v17; // [esp+4h] [ebp-F0h]
  CURLcode v18; // [esp+4h] [ebp-F0h]
  const char **v19; // [esp+8h] [ebp-ECh]
  stat sb; // [esp+Ch] [ebp-E8h] BYREF
  stat nsb; // [esp+6Ch] [ebp-88h] BYREF
  unsigned __int8 randsuffix[9]; // [esp+CFh] [ebp-25h] BYREF
  unsigned int v23; // [esp+D8h] [ebp-1Ch]
  __gid_t v24; // [esp+E0h] [ebp-14h]
  __gid_t st_gid; // [esp+E4h] [ebp-10h]

  v23 = __readgsdword(0x14u);
  *tempname = 0;
  if ( ((int (__stdcall *)(const char *, stat *, int, int, int, int, FILE **, char **))stat64)(
         filename,
         &sb,
         v13,
         v14,
         v15,
         v16,
         fh,
         tempname) == -1
    || (sb.st_mode & 0xF000) != 0x8000 )
  {
    v5 = (const char *)fopen64(filename, "w", v4, v4);
    *v17 = v5;
    if ( !v5 )
      goto LABEL_16;
    return 0;
  }
  v5 = 0;
  v6 = Curl_rand_hex(data, randsuffix, 9, 0x8000);
  if ( !v6 )
  {
    v7 = curl_maprintf("%s.%s.tmp", filename, randsuffix, 0);
    v5 = (const char *)v7;
    if ( !v7 )
    {
      v6 = 27;
      goto LABEL_17;
    }
    v8 = open64(v7, 193, 384, v7);
    v9 = v8;
    if ( v8 == -1 )
      goto LABEL_16;
    if ( fstat64(v8, &nsb, v8, v8) != -1
      && nsb.st_uid == sb.st_uid
      && nsb.st_gid == sb.st_gid
      && (st_gid = sb.st_gid, v24 = sb.st_gid, fchmod(v9, sb.st_mode) == -1)
      || (st_gid = v10, v24 = v10, v11 = fdopen(v9, "w"), (*v17 = v11) == 0) )
    {
      close(v9);
      unlink(v5);
LABEL_16:
      v6 = 23;
      goto LABEL_17;
    }
    *v19 = v5;
    return 0;
  }
LABEL_17:
  v18 = v6;
  Curl_cfree(v5);
  *v19 = 0;
  return v18;
}
