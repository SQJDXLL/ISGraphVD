CURLcode __fastcall Curl_fopen(Curl_easy *data, const char *filename, FILE **fh, char **tempname)
{
  char *v8; // r5
  __mode_t v9; // r4
  int v10; // r0
  int v11; // r7
  CURLcode v12; // r8
  FILE *v13; // r0
  CURLcode result; // r0
  int v15; // r0
  int v16; // r0
  FILE *v17; // r1
  char v18[24]; // [sp+8h] [bp-100h] BYREF
  int v19; // [sp+20h] [bp-E8h]
  int v20; // [sp+24h] [bp-E4h]
  char v21[16]; // [sp+70h] [bp-98h] BYREF
  __mode_t v22; // [sp+80h] [bp-88h]
  int v23; // [sp+88h] [bp-80h]
  int v24; // [sp+8Ch] [bp-7Ch]
  char v25[41]; // [sp+DFh] [bp-29h] BYREF

  v8 = 0;
  *tempname = 0;
  if ( stat64(filename, v21) == -1 || (v9 = v22, (v22 & 0xF000) != 0x8000) )
  {
    v13 = (FILE *)fopen64(filename, "w");
    *fh = v13;
    if ( v13 )
      return 0;
    v11 = -1;
    v12 = CURLE_WRITE_ERROR;
  }
  else
  {
    v10 = Curl_rand_hex(data, v25, 9);
    v11 = -1;
    v8 = 0;
    if ( v10 )
    {
      v12 = v10;
    }
    else
    {
      v15 = curl_maprintf("%s.%s.tmp", filename, v25);
      if ( v15 )
      {
        v8 = (char *)v15;
        v16 = open64(v15, 193, 384);
        v12 = CURLE_WRITE_ERROR;
        if ( v16 != -1 )
        {
          v11 = v16;
          if ( fstat64(v16, v18) == -1 || v19 != v23 || v20 != v24 || fchmod(v11, v9) != -1 )
          {
            v17 = fdopen(v11, "w");
            *fh = v17;
            result = CURLE_OK;
            if ( v17 )
              goto LABEL_21;
          }
          goto fail;
        }
      }
      else
      {
        v12 = CURLE_OUT_OF_MEMORY;
        v8 = 0;
      }
      v11 = -1;
    }
  }
fail:
  if ( v11 != -1 )
  {
    close(v11);
    unlink(v8);
  }
  ((void (__fastcall *)(char *))*Curl_cfree)(v8);
  v8 = 0;
  result = v12;
LABEL_21:
  *tempname = v8;
  return result;
}
