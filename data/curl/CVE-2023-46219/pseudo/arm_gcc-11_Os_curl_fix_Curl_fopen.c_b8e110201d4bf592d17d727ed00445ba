CURLcode __fastcall Curl_fopen(Curl_easy *data, const char *filename, FILE **fh, char **tempname)
{
  bool i; // zf
  size_t v9; // r6
  size_t v10; // r3
  CURLcode v11; // r5
  const char *v12; // r6
  char *v13; // r4
  FILE *v14; // r0
  int v15; // r0
  int v16; // r0
  int v17; // r0
  int v18; // r11
  FILE *v19; // r0
  stat sb; // [sp+8h] [bp-128h] BYREF
  stat nsb; // [sp+70h] [bp-C0h] BYREF
  unsigned __int8 randbuf[41]; // [sp+D8h] [bp-58h] BYREF

  *tempname = 0;
  Curl_dyn_init(&nsb, 8000000, &open64 + 8);
  v9 = strlen(filename);
  for ( i = v9 == 0; !i; i = v9 == 0 )
  {
    v10 = v9--;
    if ( filename[v9] == 47 )
    {
      while ( 1 )
      {
        v9 = v10--;
        if ( filename[v10] != 47 )
          goto LABEL_5;
        if ( !v10 )
        {
          v9 = 0;
          goto LABEL_5;
        }
      }
    }
  }
LABEL_5:
  v11 = Curl_dyn_addn(&nsb, filename, v9);
  if ( v11 || v9 && Curl_dyn_addn(&nsb, &LC0, 1) )
  {
    v12 = 0;
LABEL_7:
    v13 = (char *)v12;
LABEL_8:
    v11 = CURLE_WRITE_ERROR;
    goto LABEL_30;
  }
  v12 = (const char *)Curl_dyn_ptr(&nsb);
  if ( !v12 )
    goto LABEL_7;
  v14 = (FILE *)fopen64(filename, "w");
  v13 = (char *)v14;
  *fh = v14;
  if ( !v14 )
    goto LABEL_8;
  v15 = fileno(v14);
  if ( fstat64(v15, &sb) == -1 || (sb.st_mode & 0xF000) != 0x8000 )
    goto LABEL_18;
  fclose(*fh);
  v13 = 0;
  *fh = 0;
  v11 = Curl_rand_alnum(data);
  if ( v11 == CURLE_OK )
  {
    v16 = curl_maprintf("%s%s.tmp", v12, (const char *)randbuf);
    v13 = (char *)v16;
    if ( !v16 )
    {
      v11 = CURLE_OUT_OF_MEMORY;
      goto LABEL_30;
    }
    v17 = open64(v16, 193, 384);
    v18 = v17;
    if ( v17 != -1 )
    {
      if ( fstat64(v17, &nsb) == -1
        || nsb.st_uid != sb.st_uid
        || nsb.st_gid != sb.st_gid
        || fchmod(v18, sb.st_mode) != -1 )
      {
        v19 = fdopen(v18, "w");
        *fh = v19;
        if ( v19 )
        {
          Curl_cfree(v12);
          *tempname = v13;
          return v11;
        }
      }
      close(v18);
      unlink(v13);
    }
    goto LABEL_8;
  }
LABEL_30:
  Curl_cfree(v13);
LABEL_18:
  Curl_cfree(v12);
  return v11;
}
