CURLcode __cdecl Curl_fopen(Curl_easy *data, const char *filename, FILE **fh, char **tempname)
{
  int v4; // r0
  FILE *v5; // r0
  void (__fastcall **v7)(char *); // [sp+4h] [bp-12Ch]
  char v8[24]; // [sp+8h] [bp-128h] BYREF
  int v9; // [sp+20h] [bp-110h]
  int v10; // [sp+24h] [bp-10Ch]
  char *v11; // [sp+70h] [bp-C0h]
  int fd; // [sp+74h] [bp-BCh]
  char v13[16]; // [sp+78h] [bp-B8h] BYREF
  __mode_t mode; // [sp+88h] [bp-A8h]
  int v15; // [sp+90h] [bp-A0h]
  int v16; // [sp+94h] [bp-9Ch]
  char *tempstore; // [sp+E0h] [bp-50h]
  unsigned __int8 randbuf[41]; // [sp+E7h] [bp-49h] BYREF
  CURLcode result; // [sp+110h] [bp-20h]
  char **tempnamea; // [sp+114h] [bp-1Ch]
  FILE **fha; // [sp+118h] [bp-18h]
  const char *filenamea; // [sp+11Ch] [bp-14h]
  Curl_easy *dataa; // [sp+120h] [bp-10h]

  dataa = data;
  filenamea = filename;
  fha = fh;
  tempnamea = tempname;
  result = CURLE_WRITE_ERROR;
  tempstore = 0;
  fd = -1;
  *tempname = 0;
  v11 = dirslash(filenamea);
  if ( v11 )
  {
    *fha = (FILE *)fopen64(filenamea, "w");
    if ( *fha )
    {
      v4 = fileno(*fha);
      if ( fstat64(v4, v13) == -1 || (mode & 0xF000) != 0x8000 )
      {
        ((void (__fastcall *)(char *))*Curl_cfree)(v11);
        return 0;
      }
      fclose(*fha);
      *fha = 0;
      result = Curl_rand_alnum(dataa, randbuf, 41);
      if ( result == CURLE_OK )
      {
        tempstore = (char *)curl_maprintf("%s%s.tmp", v11, (const char *)randbuf);
        if ( tempstore )
        {
          result = CURLE_WRITE_ERROR;
          fd = open64(tempstore, 193, 384);
          if ( fd != -1 && (fstat64(fd, v8) == -1 || v9 != v15 || v10 != v16 || fchmod(fd, mode) != -1) )
          {
            v5 = fdopen(fd, "w");
            *fha = v5;
            if ( *fha )
            {
              ((void (__fastcall *)(char *))*Curl_cfree)(v11);
              *tempnamea = tempstore;
              return 0;
            }
          }
        }
        else
        {
          result = CURLE_OUT_OF_MEMORY;
        }
      }
    }
  }
  if ( fd != -1 )
  {
    close(fd);
    unlink(tempstore);
  }
  v7 = (void (__fastcall **)(char *))Curl_cfree;
  ((void (__fastcall *)(char *))*Curl_cfree)(tempstore);
  (*v7)(v11);
  return result;
}
