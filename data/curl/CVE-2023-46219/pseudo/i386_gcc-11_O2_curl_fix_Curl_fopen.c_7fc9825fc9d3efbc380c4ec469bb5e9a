CURLcode __cdecl Curl_fopen(Curl_easy *data, const char *filename, FILE **fh, char **tempname)
{
  size_t v4; // eax
  int v5; // eax
  int v6; // esi
  FILE *v7; // edx
  int v8; // eax
  CURLcode v9; // ebp
  size_t v11; // ecx
  size_t v12; // eax
  int v13; // eax
  int v14; // eax
  int v15; // eax
  int v16; // eax
  int v17; // ecx
  char *v18; // edx
  FILE *v19; // eax
  int v20; // eax
  char *name; // [esp+1Ch] [ebp-120h]
  int fd; // [esp+20h] [ebp-11Ch]
  int fda; // [esp+20h] [ebp-11Ch]
  int fdb; // [esp+20h] [ebp-11Ch]
  int v25; // [esp+2Ch] [ebp-110h]
  char *v26; // [esp+2Ch] [ebp-110h]
  stat sb; // [esp+30h] [ebp-10Ch] BYREF
  stat nsb; // [esp+90h] [ebp-ACh] BYREF
  unsigned __int8 randbuf[41]; // [esp+F3h] [ebp-49h] BYREF
  unsigned int v30; // [esp+11Ch] [ebp-20h]

  v30 = __readgsdword(0x14u);
  *tempname = 0;
  Curl_dyn_init(&nsb, 8000000);
  v4 = strlen(filename);
  if ( v4 )
  {
    while ( 1 )
    {
      v11 = v4--;
      if ( filename[v4] == 47 )
        break;
      if ( !v4 )
      {
LABEL_12:
        if ( !Curl_dyn_addn(&nsb, filename, 0) )
          goto LABEL_4;
        goto LABEL_13;
      }
    }
    while ( 1 )
    {
      v12 = v11--;
      if ( filename[v11] != 47 )
        break;
      if ( !v11 )
        goto LABEL_12;
    }
    if ( !Curl_dyn_addn(&nsb, filename, v12) )
    {
      v5 = Curl_dyn_addn(&nsb, &LC0, 1);
      goto LABEL_3;
    }
    goto LABEL_13;
  }
  v5 = Curl_dyn_addn(&nsb, filename, 0);
LABEL_3:
  if ( v5 )
  {
LABEL_13:
    v6 = 0;
    v7 = 0;
    v9 = CURLE_WRITE_ERROR;
    goto LABEL_14;
  }
LABEL_4:
  v6 = Curl_dyn_ptr(&nsb);
  if ( !v6 )
  {
    v7 = 0;
    v9 = CURLE_WRITE_ERROR;
    goto LABEL_14;
  }
  v7 = (FILE *)fopen64(filename, "w");
  *fh = v7;
  if ( !v7 )
  {
LABEL_27:
    v9 = CURLE_WRITE_ERROR;
    goto LABEL_14;
  }
  v8 = fileno(v7);
  if ( fstat64(v8, &sb) != -1 && (sb.st_mode & 0xF000) == 0x8000 )
  {
    fclose(*fh);
    *fh = 0;
    v13 = Curl_rand_alnum(data, randbuf, 41);
    v7 = 0;
    v9 = v13;
    if ( !v13 )
    {
      v14 = curl_maprintf("%s%s.tmp", v6, randbuf);
      v7 = (FILE *)v14;
      if ( !v14 )
      {
        v9 = CURLE_OUT_OF_MEMORY;
        goto LABEL_14;
      }
      fd = v14;
      v15 = open64(v14, 193, 384);
      v7 = (FILE *)fd;
      if ( v15 != -1 )
      {
        v25 = fd;
        fda = v15;
        v16 = fstat64(v15, &nsb);
        v17 = fda;
        v18 = (char *)v25;
        if ( v16 == -1
          || nsb.st_uid != sb.st_uid
          || nsb.st_gid != sb.st_gid
          || (v20 = fchmod(fda, sb.st_mode), v17 = fda, v18 = (char *)v25, v20 != -1) )
        {
          v26 = v18;
          fdb = v17;
          v19 = fdopen(v17, "w");
          v17 = fdb;
          *fh = v19;
          v18 = v26;
          if ( v19 )
          {
            Curl_cfree(v6);
            *tempname = v26;
            return v9;
          }
        }
        name = v18;
        v9 = CURLE_WRITE_ERROR;
        close(v17);
        unlink(name);
        v7 = (FILE *)name;
        goto LABEL_14;
      }
      goto LABEL_27;
    }
LABEL_14:
    Curl_cfree(v7);
    Curl_cfree(v6);
    return v9;
  }
  v9 = CURLE_OK;
  Curl_cfree(v6);
  return v9;
}
