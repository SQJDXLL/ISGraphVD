int __fastcall Curl_fopen(Curl_easy *data, const char *filename, FILE **fh, char **tempname)
{
  size_t v7; // $s1
  size_t v8; // $a2
  int v9; // $s0
  int v10; // $s1
  char *v11; // $s6
  size_t v12; // $v0
  FILE *v13; // $v0
  int v14; // $v0
  int v15; // $v0
  int v16; // $v0
  int v17; // $v0
  int v18; // $a0
  int v19; // $v0
  FILE *v20; // $v0
  int fda; // [sp+18h] [-188h]
  int fdb; // [sp+18h] [-188h]
  char v25[16]; // [sp+20h] [-180h] BYREF
  stat sb; // [sp+30h] [-170h] BYREF
  stat nsb; // [sp+D0h] [-D0h] BYREF
  unsigned __int8 randbuf[41]; // [sp+170h] [-30h] BYREF

  *tempname = 0;
  Curl_dyn_init(v25, 8000000);
  v7 = strlen(filename);
  if ( v7 )
  {
    while ( 1 )
    {
      v12 = v7--;
      if ( filename[v7] == 47 )
        break;
      if ( !v7 )
        goto LABEL_2;
    }
    while ( 1 )
    {
      v7 = v12--;
      if ( filename[v12] != 47 )
        break;
      v7 = 0;
      if ( !v12 )
      {
        v8 = 0;
        goto LABEL_3;
      }
    }
  }
LABEL_2:
  v8 = v7;
LABEL_3:
  v9 = Curl_dyn_addn(v25, filename, v8);
  if ( v9 || v7 && Curl_dyn_addn(v25, &_LC0, 1) )
  {
    v10 = 0;
LABEL_5:
    v11 = 0;
LABEL_6:
    v9 = 23;
    Curl_cfree(v11);
    goto LABEL_18;
  }
  v10 = Curl_dyn_ptr(v25);
  if ( !v10 )
    goto LABEL_5;
  v13 = (FILE *)fopen64(filename, "w");
  v11 = (char *)v13;
  *fh = v13;
  if ( !v13 )
    goto LABEL_6;
  v14 = fileno(v13);
  if ( fstat64(v14, &sb) == -1 || (sb.st_mode & 0xF000) != 0x8000 )
    goto LABEL_18;
  fclose(*fh);
  *fh = 0;
  v9 = Curl_rand_alnum(data);
  if ( v9 )
    goto LABEL_29;
  v15 = curl_maprintf("%s%s.tmp", v10, randbuf);
  v11 = (char *)v15;
  if ( !v15 )
  {
    v9 = 27;
LABEL_29:
    Curl_cfree(0);
    goto LABEL_18;
  }
  v16 = open64(v15, 1281, 384);
  if ( v16 == -1 )
    goto LABEL_6;
  fda = v16;
  v17 = fstat64(v16, &nsb);
  v18 = fda;
  if ( v17 == -1
    || nsb.st_uid != sb.st_uid
    || nsb.st_gid != sb.st_gid
    || (v19 = fchmod(fda, sb.st_mode), v18 = fda, v19 != -1) )
  {
    fdb = v18;
    v20 = fdopen(v18, "w");
    *fh = v20;
    v18 = fdb;
    if ( v20 )
    {
      Curl_cfree(v10);
      *tempname = v11;
      return v9;
    }
  }
  v9 = 23;
  close(v18);
  unlink(v11);
  Curl_cfree(v11);
LABEL_18:
  Curl_cfree(v10);
  return v9;
}
