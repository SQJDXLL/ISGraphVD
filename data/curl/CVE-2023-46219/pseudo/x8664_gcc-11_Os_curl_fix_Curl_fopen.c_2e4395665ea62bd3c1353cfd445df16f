CURLcode __fastcall Curl_fopen(Curl_easy *data, const char *filename, FILE **fh, char **tempname)
{
  size_t v5; // r15
  bool i; // zf
  size_t v7; // rax
  CURLcode v8; // r12d
  const char *v9; // r13
  FILE *v10; // rax
  char *v11; // rbp
  int v12; // eax
  const char *v13; // rax
  int v14; // eax
  int v15; // r14d
  FILE *v16; // rax
  char v19[32]; // [rsp+18h] [rbp-1B0h] BYREF
  stat sb; // [rsp+38h] [rbp-190h] BYREF
  stat nsb; // [rsp+C8h] [rbp-100h] BYREF
  unsigned __int8 randbuf[41]; // [rsp+15Fh] [rbp-69h] BYREF
  unsigned __int64 v23; // [rsp+188h] [rbp-40h]

  v23 = __readfsqword(0x28u);
  *tempname = 0LL;
  Curl_dyn_init(v19, 8000000LL);
  v5 = strlen(filename);
  for ( i = v5 == 0; !i; i = v5 == 0 )
  {
    v7 = v5--;
    if ( filename[v5] == 47 )
    {
      while ( 1 )
      {
        v5 = v7--;
        if ( filename[v5 - 1] != 47 )
          goto LABEL_8;
        if ( !v7 )
        {
          v5 = 0LL;
          goto LABEL_8;
        }
      }
    }
  }
LABEL_8:
  v8 = (unsigned int)Curl_dyn_addn(v19, filename, v5);
  if ( v8 || v5 && (unsigned int)Curl_dyn_addn(v19, &LC0, 1LL) )
  {
    v9 = 0LL;
LABEL_25:
    v11 = 0LL;
    goto LABEL_28;
  }
  v9 = (const char *)Curl_dyn_ptr(v19);
  if ( !v9 )
    goto LABEL_25;
  v10 = fopen(filename, "w");
  *fh = v10;
  v11 = (char *)v10;
  if ( !v10 )
  {
LABEL_28:
    v8 = CURLE_WRITE_ERROR;
    goto LABEL_29;
  }
  v12 = fileno(v10);
  if ( fstat(v12, &sb) == -1 || (sb.st_mode & 0xF000) != 0x8000 )
    goto LABEL_30;
  v11 = 0LL;
  fclose(*fh);
  *fh = 0LL;
  v8 = (unsigned int)Curl_rand_alnum(data, randbuf, 41LL);
  if ( v8 )
  {
LABEL_29:
    Curl_cfree(v11);
LABEL_30:
    Curl_cfree(v9);
    return v8;
  }
  v13 = (const char *)curl_maprintf("%s%s.tmp", v9, (const char *)randbuf);
  v11 = (char *)v13;
  if ( !v13 )
  {
    v8 = CURLE_OUT_OF_MEMORY;
    goto LABEL_29;
  }
  v14 = open(v13, 193, 384LL);
  v15 = v14;
  if ( v14 == -1 )
    goto LABEL_28;
  if ( fstat(v14, &nsb) != -1 && nsb.st_uid == sb.st_uid && nsb.st_gid == sb.st_gid && fchmod(v15, sb.st_mode) == -1
    || (v16 = fdopen(v15, "w"), (*fh = v16) == 0LL) )
  {
    close(v15);
    unlink(v11);
    goto LABEL_28;
  }
  Curl_cfree(v9);
  *tempname = v11;
  return v8;
}
