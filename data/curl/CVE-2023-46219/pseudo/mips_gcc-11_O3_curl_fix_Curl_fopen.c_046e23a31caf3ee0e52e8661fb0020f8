int __fastcall Curl_fopen(Curl_easy *data, const char *filename, FILE **fh, char **tempname)
{
  int v4; // $v0
  size_t v9; // $v0
  size_t v10; // $v1
  int v11; // $s5
  char *v12; // $s0
  int v13; // $s3
  FILE *v14; // $v0
  int v15; // $v0
  size_t v17; // $a2
  int v18; // $v0
  int v19; // $v0
  int v20; // $v0
  int v21; // $a0
  FILE *v22; // $v0
  int v23; // $v0
  int fd; // [sp+1Ch] [-188h]
  int fda; // [sp+1Ch] [-188h]
  char v26[16]; // [sp+20h] [-184h] BYREF
  stat sb; // [sp+30h] [-174h] BYREF
  stat nsb; // [sp+D0h] [-D4h] BYREF
  unsigned __int8 randbuf[41]; // [sp+170h] [-34h] BYREF
  int v30; // [sp+19Ch] [-8h]

  v4 = _stack_chk_guard;
  *tempname = 0;
  v30 = v4;
  Curl_dyn_init(v26, 8000000);
  v9 = strlen(filename);
  if ( v9 )
  {
    v10 = v9;
    while ( filename[--v9] != 47 )
    {
      v10 = v9;
      if ( !v9 )
      {
LABEL_5:
        if ( !Curl_dyn_addn(v26, filename, 0) )
          goto LABEL_10;
        goto LABEL_6;
      }
    }
    while ( 1 )
    {
      v17 = v10--;
      if ( filename[v10] != 47 )
        break;
      if ( !v10 )
        goto LABEL_5;
    }
    if ( Curl_dyn_addn(v26, filename, v17) )
      goto LABEL_6;
    if ( !Curl_dyn_addn(v26, &_LC0, 1) )
      goto LABEL_10;
    v11 = 0;
  }
  else
  {
    if ( !Curl_dyn_addn(v26, filename, 0) )
    {
LABEL_10:
      v11 = Curl_dyn_ptr(v26);
      if ( !v11 )
      {
        v12 = 0;
        v13 = 23;
        goto LABEL_8;
      }
      v14 = (FILE *)fopen64(filename, "w");
      v12 = (char *)v14;
      *fh = v14;
      if ( v14 )
      {
        v15 = fileno(v14);
        if ( fstat64(v15, &sb) == -1 || (sb.st_mode & 0xF000) != 0x8000 )
        {
          v13 = 0;
          Curl_cfree(v11);
          return v13;
        }
        fclose(*fh);
        *fh = 0;
        v13 = Curl_rand_alnum(data, randbuf, 41);
        if ( v13 )
        {
          v12 = 0;
          goto LABEL_8;
        }
        v18 = curl_maprintf("%s%s.tmp", v11, randbuf);
        v12 = (char *)v18;
        if ( !v18 )
        {
          v13 = 27;
          goto LABEL_8;
        }
        v19 = open64(v18, 1281, 384);
        if ( v19 != -1 )
        {
          fd = v19;
          v20 = fstat64(v19, &nsb);
          v21 = fd;
          if ( v20 == -1
            || nsb.st_uid != sb.st_uid
            || nsb.st_gid != sb.st_gid
            || (v23 = fchmod(fd, sb.st_mode), v21 = fd, v23 != -1) )
          {
            fda = v21;
            v22 = fdopen(v21, "w");
            v21 = fda;
            *fh = v22;
            if ( v22 )
            {
              Curl_cfree(v11);
              *tempname = v12;
              return v13;
            }
          }
          v13 = 23;
          close(v21);
          unlink(v12);
          goto LABEL_8;
        }
      }
      v13 = 23;
      goto LABEL_8;
    }
LABEL_6:
    v11 = 0;
  }
  v12 = 0;
  v13 = 23;
LABEL_8:
  Curl_cfree(v12);
  Curl_cfree(v11);
  return v13;
}
