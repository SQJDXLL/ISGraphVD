CURLcode __cdecl Curl_fopen(Curl_easy *data, const char *filename, FILE **fh, char **tempname)
{
  size_t v4; // eax
  int v5; // esi
  FILE *v6; // edx
  int v7; // eax
  size_t v9; // ecx
  int v10; // eax
  int v11; // eax
  int v12; // eax
  int v13; // eax
  int v14; // ecx
  char *v15; // edx
  FILE *v16; // eax
  int v17; // eax
  char *name; // [esp+1Ch] [ebp-120h]
  char *namea; // [esp+1Ch] [ebp-120h]
  int fd; // [esp+20h] [ebp-11Ch]
  int fda; // [esp+20h] [ebp-11Ch]
  int fdb; // [esp+20h] [ebp-11Ch]
  int v23; // [esp+2Ch] [ebp-110h]
  char *v24; // [esp+2Ch] [ebp-110h]
  stat sb; // [esp+30h] [ebp-10Ch] BYREF
  stat nsb; // [esp+90h] [ebp-ACh] BYREF
  unsigned __int8 randbuf[41]; // [esp+F3h] [ebp-49h] BYREF
  unsigned int v28; // [esp+11Ch] [ebp-20h]

  v28 = __readgsdword(0x14u);
  *tempname = 0;
  Curl_dyn_init(&nsb, 8000000);
  v4 = strlen(filename);
  if ( v4 )
  {
    while ( 1 )
    {
      v9 = v4--;
      if ( filename[v4] == 47 )
        break;
      if ( !v4 )
        goto LABEL_2;
    }
    while ( v9 )
    {
      if ( filename[v9 - 1] != 47 )
      {
        if ( !Curl_dyn_addn(&nsb, filename, v9) && !Curl_dyn_addn(&nsb, &LC0, 1) )
          goto LABEL_3;
        goto LABEL_16;
      }
      --v9;
    }
  }
LABEL_2:
  if ( Curl_dyn_addn(&nsb, filename, 0) )
  {
LABEL_16:
    v5 = 0;
    v6 = 0;
    v10 = 23;
LABEL_17:
    name = (char *)v10;
    Curl_cfree(v6);
    Curl_cfree(v5);
    return (CURLcode)name;
  }
LABEL_3:
  v5 = Curl_dyn_ptr(&nsb);
  if ( !v5 )
  {
    v6 = 0;
    v10 = 23;
    goto LABEL_17;
  }
  v6 = (FILE *)fopen64(filename, "w");
  *fh = v6;
  if ( !v6 )
    goto LABEL_25;
  v7 = fileno(v6);
  if ( fstat64(v7, &sb) == -1 || (sb.st_mode & 0xF000) != 0x8000 )
  {
    Curl_cfree(v5);
    return 0;
  }
  fclose(*fh);
  *fh = 0;
  v10 = Curl_rand_alnum(data, randbuf, 41);
  v6 = 0;
  if ( v10 )
    goto LABEL_17;
  v11 = curl_maprintf("%s%s.tmp", v5, randbuf);
  v6 = (FILE *)v11;
  if ( !v11 )
  {
    v10 = 27;
    goto LABEL_17;
  }
  fd = v11;
  v12 = open64(v11, 193, 384);
  v6 = (FILE *)fd;
  if ( v12 == -1 )
  {
LABEL_25:
    v10 = 23;
    goto LABEL_17;
  }
  v23 = fd;
  fda = v12;
  v13 = fstat64(v12, &nsb);
  v14 = fda;
  v15 = (char *)v23;
  if ( v13 != -1 && nsb.st_uid == sb.st_uid && nsb.st_gid == sb.st_gid )
  {
    v17 = fchmod(fda, sb.st_mode);
    v14 = fda;
    v15 = (char *)v23;
    if ( v17 == -1 )
      goto LABEL_28;
  }
  v24 = v15;
  fdb = v14;
  v16 = fdopen(v14, "w");
  v14 = fdb;
  v15 = v24;
  *fh = v16;
  if ( !v16 )
  {
LABEL_28:
    namea = v15;
    close(v14);
    unlink(namea);
    v10 = 23;
    v6 = (FILE *)namea;
    goto LABEL_17;
  }
  Curl_cfree(v5);
  *tempname = v24;
  return 0;
}
