int __fastcall add_pseudoheader(
        dns_header *header,
        size_t plen,
        unsigned __int8 *limit,
        unsigned __int16 udp_sz,
        int a5,
        int a6,
        int a7,
        int a8,
        int optno,
        unsigned __int8 *opt,
        size_t optlen,
        int set_do,
        int replace)
{
  int v13; // $s4
  unsigned __int8 *pseudoheader; // $v0
  size_t v16; // $s2
  int v17; // $s5
  unsigned __int8 *v18; // $s1
  unsigned __int8 *v19; // $s1
  unsigned int v20; // $s6
  unsigned int v21; // $v0
  __int16 v22; // $s3
  unsigned int v23; // $v0
  char *v24; // $s4
  int v25; // $a3
  char *v26; // $t0
  _BYTE *v27; // $s1
  unsigned __int8 *v28; // $v0
  int v29; // $s6
  int v30; // $a0
  _BYTE *v31; // $v0
  _BYTE *v32; // $a3
  _BYTE *v33; // $v0
  unsigned int v34; // $v0
  unsigned __int16 v35; // $a0
  unsigned int v36; // $v0
  int v37; // $a1
  int v38; // $a1
  int v39; // $a1
  unsigned int v41; // [sp+24h] [-24h]
  _BYTE *v42; // [sp+24h] [-24h]
  int i; // [sp+34h] [-14h]
  unsigned __int8 *udp_len; // [sp+38h] [-10h] BYREF
  int is_sign; // [sp+3Ch] [-Ch] BYREF
  int is_last; // [sp+40h] [-8h] BYREF

  LOWORD(v13) = udp_sz;
  v16 = plen;
  pseudoheader = find_pseudoheader(header, plen, 0u, &udp_len, &is_sign, &is_last);
  v17 = is_sign;
  if ( is_sign )
    return v16;
  v18 = pseudoheader;
  if ( pseudoheader )
  {
    v19 = udp_len;
    v41 = (udp_len[1] << 8) | *udp_len;
    v20 = (udp_len[3] << 8) | udp_len[2];
    v21 = (udp_len[5] << 8) | udp_len[4];
    v22 = ((_WORD)v21 << 8) | (v21 >> 8);
    if ( set_do )
    {
      v22 |= 0x8000u;
      udp_len[4] = HIBYTE(v22);
      v19[5] = v22;
    }
    v23 = (v19[7] << 8) | v19[6];
    v24 = (char *)(v19 + 8);
    v17 = (unsigned __int16)(((_WORD)v23 << 8) | (v23 >> 8));
    if ( v16 < v19 + 8 - (unsigned __int8 *)header + v17 )
      return v16;
    v25 = 0;
    if ( !optno )
      return v16;
    v26 = (char *)(v19 + 8);
    while ( v25 + 4 < v17 )
    {
      v34 = ((unsigned __int8)v26[1] << 8) | (unsigned __int8)*v26;
      v35 = ((_WORD)v34 << 8) | (v34 >> 8);
      v36 = ((unsigned __int8)v26[3] << 8) | (unsigned __int8)v26[2];
      v37 = (unsigned __int16)(((_WORD)v36 << 8) | (v36 >> 8));
      if ( v17 < v37 + v25 )
      {
        is_last = 0;
LABEL_27:
        v17 = 0;
        v18 = 0;
        goto LABEL_13;
      }
      if ( v35 == optno )
      {
        v38 = v37 + 4;
        if ( !replace )
          return v16;
        v17 -= v38;
        i = v25;
        v26 = (char *)memcpy(v26, &v26[v38], v17 - v25);
        v25 = i;
        v19[6] = BYTE1(v17);
        v19[7] = v17;
      }
      else
      {
        v39 = v37 + 4;
        v26 += v39;
        v25 += v39;
      }
    }
    v27 = v19 + 6;
    if ( is_last )
      goto LABEL_20;
    if ( !v17 )
      goto LABEL_27;
    v28 = (unsigned __int8 *)whine_malloc(v17);
    v18 = v28;
    if ( v28 )
      memcpy(v28, v24, v17);
LABEL_13:
    v13 = (v41 << 8) | (v41 >> 8);
    v29 = (v20 << 8) | (v20 >> 8);
    v16 = rrfilter(header, v16, 0);
  }
  else
  {
    LOWORD(v29) = 0;
    v22 = (set_do != 0) << 15;
  }
  v30 = skip_questions(header, v16);
  if ( v30 )
  {
    v31 = (_BYTE *)skip_section(
                     v30,
                     (unsigned __int16)((header->ancount << 8) | HIBYTE(header->ancount))
                   + (unsigned __int16)((header->nscount << 8) | HIBYTE(header->nscount))
                   + (unsigned __int16)((header->arcount << 8) | HIBYTE(header->arcount)),
                     header,
                     v16);
    v32 = v31;
    if ( v31 )
    {
      *v31 = 0;
      v31[1] = 0;
      v31[2] = 41;
      v31[3] = BYTE1(v13);
      v31[5] = BYTE1(v29);
      v31[7] = HIBYTE(v22);
      v31[4] = v13;
      v24 = v31 + 0xB;
      v31[6] = v29;
      v31[8] = v22;
      v31[9] = BYTE1(v17);
      v31[10] = v17;
      v26 = v31 + 0xB;
      if ( v18 )
      {
        v42 = v31;
        memcpy(v31 + 0xB, v18, v17);
        free(v18);
        v32 = v42;
        v26 = &v24[v17];
      }
      v27 = v32 + 9;
      if ( limit - (unsigned __int8 *)(v26 + 4) >= (int)optlen )
        header->arcount = ((((unsigned __int16)(header->arcount << 8) | HIBYTE(header->arcount)) + 1) << 8) | ((unsigned __int16)(((header->arcount << 8) | HIBYTE(header->arcount)) + 1) >> 8);
LABEL_20:
      if ( limit - (unsigned __int8 *)(v26 + 4) >= (int)optlen )
      {
        v16 = v26 - (char *)header;
        if ( optno )
        {
          if ( replace != 2 )
          {
            *v26 = BYTE1(optno);
            v26[1] = optno;
            v26[2] = BYTE1(optlen);
            v26[3] = optlen;
            v33 = memcpy(v26 + 4, opt, optlen);
            *v27 = (unsigned __int16)((_WORD)v33 + optlen - (_WORD)v24) >> 8;
            v27[1] = (_BYTE)v33 + optlen - (_BYTE)v24;
            return &v33[optlen] - (_BYTE *)header;
          }
        }
      }
    }
  }
  return v16;
}
