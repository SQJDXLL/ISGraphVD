int __fastcall add_pseudoheader(
        dns_header *header,
        size_t plen,
        unsigned __int8 *limit,
        unsigned __int16 udp_sz,
        int a5,
        int a6,
        int a7,
        int a8,
        int optno,
        unsigned __int8 *opt,
        size_t optlen,
        int set_do,
        int replace)
{
  int v13; // $v0
  _BYTE *v14; // $at
  uint16_t v15; // $v0
  int v17; // [sp+1Ch] [+1Ch]
  int v18; // [sp+20h] [+20h]
  void *v19; // [sp+24h] [+24h]
  _BYTE *v20; // [sp+40h] [+40h]
  char v21; // [sp+45h] [+45h]
  _BYTE *v22; // [sp+48h] [+48h]
  _BYTE *v23; // [sp+50h] [+50h]
  _BYTE *v24; // [sp+58h] [+58h]
  char v25; // [sp+5Dh] [+5Dh]
  _BYTE *v26; // [sp+60h] [+60h]
  _BYTE *v27; // [sp+68h] [+68h]
  _BYTE *v28; // [sp+70h] [+70h]
  char v29; // [sp+75h] [+75h]
  _BYTE *v30; // [sp+78h] [+78h]
  _BYTE *v31; // [sp+80h] [+80h]
  char v32; // [sp+85h] [+85h]
  _BYTE *v33; // [sp+94h] [+94h]
  unsigned __int16 v34; // [sp+A8h] [+A8h]
  unsigned __int16 v35; // [sp+ACh] [+ACh]
  int v36; // [sp+B0h] [+B0h]
  unsigned __int16 v37; // [sp+B4h] [+B4h]
  unsigned __int16 v38; // [sp+B8h] [+B8h]
  int v39; // [sp+BCh] [+BCh] BYREF
  int v40; // [sp+C0h] [+C0h] BYREF
  size_t n; // [sp+C4h] [+C4h]
  void *dest; // [sp+C8h] [+C8h]
  unsigned __int8 *v43; // [sp+CCh] [+CCh] BYREF
  void *pseudoheader; // [sp+D0h] [+D0h]
  void *src; // [sp+D4h] [+D4h]
  _BYTE *v46; // [sp+D8h] [+D8h]
  unsigned __int16 v47; // [sp+DCh] [+DCh]
  unsigned __int8 *v48; // [sp+E0h] [+E0h]
  size_t plena; // [sp+E4h] [+E4h]
  dns_header *headera; // [sp+E8h] [+E8h]

  headera = header;
  plena = plen;
  v48 = limit;
  v47 = udp_sz;
  dest = 0;
  n = 0;
  v38 = (set_do != 0) << 15;
  v37 = 0;
  pseudoheader = find_pseudoheader(header, plen, 0u, &v43, &v40, &v39);
  if ( v40 )
    return plena;
  if ( pseudoheader )
  {
    pseudoheader = v43;
    v47 = _byteswap_ushort(*(_WORD *)v43);
    pseudoheader = v43 + 2;
    v37 = _byteswap_ushort(*((_WORD *)v43 + 1));
    pseudoheader = v43 + 4;
    v38 = _byteswap_ushort(*((_WORD *)v43 + 2));
    pseudoheader = v43 + 6;
    if ( set_do )
    {
      pseudoheader = (char *)pseudoheader - 2;
      v38 |= 0x8000u;
      v33 = (char *)pseudoheader + 1;
      *(_BYTE *)pseudoheader = HIBYTE(v38);
      *v33 = v38;
      pseudoheader = (char *)pseudoheader + 2;
    }
    v46 = pseudoheader;
    n = (*(unsigned __int8 *)pseudoheader << 8) | *((unsigned __int8 *)pseudoheader + 1);
    pseudoheader = (char *)pseudoheader + 2;
    if ( plena < (_BYTE *)pseudoheader - (_BYTE *)headera + n )
      return plena;
    src = pseudoheader;
    if ( !optno )
      return plena;
    v36 = 0;
    while ( v36 + 4 < (int)n )
    {
      v35 = _byteswap_ushort(*(_WORD *)pseudoheader);
      pseudoheader = (char *)pseudoheader + 2;
      v34 = _byteswap_ushort(*(_WORD *)pseudoheader);
      pseudoheader = (char *)pseudoheader + 2;
      if ( (int)n < v36 + v34 + 4 )
      {
        n = 0;
        v39 = 0;
        break;
      }
      if ( v35 == optno )
      {
        if ( !replace )
          return plena;
        pseudoheader = (char *)pseudoheader - 4;
        n = n - v34 - 4;
        memcpy(pseudoheader, (char *)pseudoheader + v34 + 4, n - v36);
        v32 = n;
        v31 = v46 + 1;
        *v46 = BYTE2(n);
        *v31 = v32;
        v46 += 2;
        v46 -= 2;
      }
      else
      {
        pseudoheader = (char *)pseudoheader + v34;
        v36 += v34 + 4;
      }
    }
    if ( !v39 )
    {
      if ( n )
      {
        dest = (void *)whine_malloc(n);
        if ( dest )
          memcpy(dest, src, n);
      }
      plena = rrfilter(headera, plena, 0);
      pseudoheader = 0;
    }
  }
  if ( !pseudoheader )
  {
    pseudoheader = (void *)skip_questions(headera, plena);
    if ( !pseudoheader )
      return plena;
    v19 = pseudoheader;
    v18 = ntohs(headera->ancount);
    v17 = v18 + ntohs(headera->nscount);
    v13 = ntohs(headera->arcount);
    pseudoheader = (void *)skip_section(v19, v17 + v13, headera, plena);
    if ( !pseudoheader )
      return plena;
    if ( v48 < (unsigned __int8 *)((char *)pseudoheader + 11) )
      return plena;
    v14 = pseudoheader;
    pseudoheader = (char *)pseudoheader + 1;
    *v14 = 0;
    v30 = (char *)pseudoheader + 1;
    *(_BYTE *)pseudoheader = 0;
    *v30 = 41;
    pseudoheader = (char *)pseudoheader + 2;
    v29 = v47;
    v28 = (char *)pseudoheader + 1;
    *(_BYTE *)pseudoheader = HIBYTE(v47);
    *v28 = v29;
    pseudoheader = (char *)pseudoheader + 2;
    v27 = (char *)pseudoheader + 1;
    *(_BYTE *)pseudoheader = HIBYTE(v37);
    *v27 = v37;
    pseudoheader = (char *)pseudoheader + 2;
    v26 = (char *)pseudoheader + 1;
    *(_BYTE *)pseudoheader = HIBYTE(v38);
    *v26 = v38;
    pseudoheader = (char *)pseudoheader + 2;
    v46 = pseudoheader;
    v25 = n;
    v24 = (char *)pseudoheader + 1;
    *(_BYTE *)pseudoheader = BYTE2(n);
    *v24 = v25;
    pseudoheader = (char *)pseudoheader + 2;
    src = pseudoheader;
    if ( dest )
    {
      if ( v48 < (unsigned __int8 *)((char *)pseudoheader + n) )
      {
        free(dest);
        return plena;
      }
      memcpy(pseudoheader, dest, n);
      free(dest);
      pseudoheader = (char *)pseudoheader + n;
    }
    if ( v48 - (_BYTE *)pseudoheader - 4 >= (int)optlen )
    {
      v15 = ntohs(headera->arcount);
      headera->arcount = htons(v15 + 1);
    }
  }
  if ( v48 - (_BYTE *)pseudoheader - 4 >= (int)optlen )
  {
    if ( optno && replace != 2 )
    {
      if ( v48 < (unsigned __int8 *)((char *)pseudoheader + 4) )
        return plena;
      v23 = (char *)pseudoheader + 1;
      *(_BYTE *)pseudoheader = BYTE2(optno);
      *v23 = optno;
      pseudoheader = (char *)pseudoheader + 2;
      v22 = (char *)pseudoheader + 1;
      *(_BYTE *)pseudoheader = BYTE2(optlen);
      *v22 = optlen;
      pseudoheader = (char *)pseudoheader + 2;
      if ( v48 < (unsigned __int8 *)((char *)pseudoheader + optlen) )
        return plena;
      memcpy(pseudoheader, opt, optlen);
      pseudoheader = (char *)pseudoheader + optlen;
      v21 = (_BYTE)pseudoheader - (_BYTE)src;
      v20 = v46 + 1;
      *v46 = (unsigned __int16)((_WORD)pseudoheader - (_WORD)src) >> 8;
      *v20 = v21;
      v46 += 2;
    }
    return (_BYTE *)pseudoheader - (_BYTE *)headera;
  }
  return plena;
}
